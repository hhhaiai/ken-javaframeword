(function(a){a.omWidget("om.omItemSelector",{options:{width:"250px",height:"200px",dataSource:[],value:[],clientFormatter:false,autoSort:false,preProcess:function(b){return b},toolbarIcons:false,onError:jQuery.noop,onSuccess:jQuery.noop,onBeforeItemSelect:jQuery.noop,onBeforeItemDeselect:jQuery.noop,onItemSelect:jQuery.noop,onItemDeselect:jQuery.noop,onSort:jQuery.noop},_create:function(){this.element.addClass("om-itemselector om-widget").html('<table style="height:100%;width:100%" cellpadding="0" cellspacing="0"><tr><td class="om-itemselector-leftpanel"></td><td class="om-itemselector-toolbar"></td><td class="om-itemselector-rightpanel"></td></tr></table>');var b=a("td",this.element);this.leftPanel=a('<fieldset><legend class="om-itemselector-title"><span></span></legend><div class="om-itemselector-items"><dl></dl></div></fieldset>').appendTo(b.eq(0));this.toolbar=a("<div></div>").appendTo(b.eq(1));this.rightPanel=this.leftPanel.clone().appendTo(b.eq(2))},_init:function(){var d=this.options,c=d.dataSource;a(">legend>span",this.leftPanel).html(a.om.lang._get(d,"omItemSelector","availableTitle"));a(">legend>span",this.rightPanel).html(a.om.lang._get(d,"omItemSelector","selectedTitle"));this.element.css({width:d.width,height:d.height});this._buildToolbar();this._resizeFieldSet();this._bindEvents();if(typeof c==="string"){var b=this;a.ajax({url:c,method:"GET",dataType:"json",success:function(e,f){if(b._trigger("onSuccess",null,e,f)===false){return}e=d.preProcess(e);d.dataSource=e;b._buildList()},error:function(e,g,f){b._trigger("onError",null,e,g,f)}})}else{this._buildList()}},_buildToolbar:function(){var f=this.options,e=f.toolbarIcons,b=f.autoSort,c="",d=["space","addAll","add","remove","removeAll","moveTop","moveUp","moveDown","moveBottom"];if(!jQuery.isArray(e)){e=[1,2,3,4]}a.each(e,function(g,i){var h=d[i],j;if(!h||(b&&i>3)){}else{c+='<div class="om-icon om-itemselector-tbar-'+h+'" title="'+(a.om.lang._get({},"omItemSelector",h+"IconTip")||"")+'"></div>'}});this.toolbar.html(c)},_resizeFieldSet:function(){var e=this.leftPanel,f=this.rightPanel,c=a(".om-itemselector-items",e),h=a(".om-itemselector-items",f),d=e.parent().innerHeight()-c.offset().top+e.offset().top,b=(a("tr",this.element).innerWidth()-this.toolbar.outerWidth())/2,g=e.outerWidth(b).innerWidth();c.outerHeight(d).width(g);h.outerHeight(d).width(g)},_buildList:function(){var b=this.options;dataSource=b.dataSource,value=b.value,fmt=b.clientFormatter,leftHtml="",rightHtml="",inArray=function(f,d){for(var e=0,c=d.length;e<c;e++){if(f.value===d[e]){return true}}return false},buildHtml=fmt?function(c,d){return'<dt _index="'+c+'">'+fmt(d,c)+"</dt>"}:function(c,d){return'<dt _index="'+c+'">'+d.text+"</dt>"};if(a.isArray(dataSource)&&jQuery.isArray(value)){a.each(dataSource,function(c,d){if(inArray(d,value)){rightHtml+=buildHtml(c,d)}else{leftHtml+=buildHtml(c,d)}})}a(".om-itemselector-items>dl",this.leftPanel).html(leftHtml);a(".om-itemselector-items>dl",this.rightPanel).html(rightHtml);this._makeDraggable()},_makeDraggable:function(){var c=this,b=this.options.autoSort,d=a(".om-itemselector-items>dl",this.element);d.attr("onselectstart","javascript:return false;");if(!b){d.sortable({placeholder:"om-itemselector-placeholder",start:function(f,e){a(".om-itemselector-items>dl>dt",c.element).removeClass("om-state-highlight");f.item.addClass("om-state-highlight");f.item.oldIndex=f.item.index()},stop:function(f,e){c._trigger("onSort",null,c.options.dataSource[f.item.attr("_index")],f.item.oldIndex,f.item.index())}}).disableSelection()}},_bindEvents:function(){var c=this,d=this.toolbar,e=this.options;this.leftPanel.delegate(".om-itemselector-items>dl>dt","click.omItemSelector",function(){a(".om-itemselector-items>dl>dt",c.element).removeClass("om-state-highlight");a(this).addClass("om-state-highlight")});this.rightPanel.delegate(".om-itemselector-items>dl>dt","click",function(){a(".om-itemselector-items>dl>dt",c.element).removeClass("om-state-highlight");a(this).addClass("om-state-highlight")});this.leftPanel.delegate(".om-itemselector-items>dl>dt","dblclick",function(){c._moveItemsToTarget(".om-state-highlight",true)});this.rightPanel.delegate(".om-itemselector-items>dl>dt","dblclick",function(){c._moveItemsToTarget(".om-state-highlight",false)});a(".om-itemselector-tbar-add",d).click(function(){c._moveItemsToTarget(".om-state-highlight",true)});a(".om-itemselector-tbar-remove",d).click(function(){c._moveItemsToTarget(".om-state-highlight",false)});a(".om-itemselector-tbar-addAll",d).click(function(){c._moveItemsToTarget("",true)});a(".om-itemselector-tbar-removeAll",d).click(function(){c._moveItemsToTarget("",false)});if(!e.autoSort){var b=".om-itemselector-items>dl>dt.om-state-highlight:first";a(".om-itemselector-tbar-moveTop",d).click(function(){var f=c.rightPanel,h=a(b,f);if(h.size()==0){f=c.leftPanel;h=a(b,f)}var g=h.index();if(h.size()==0||g==0){return}h.prependTo(a(".om-itemselector-items>dl",f));c._trigger("onSort",null,e.dataSource[h.attr("_index")],g,0)});a(".om-itemselector-tbar-moveBottom",d).click(function(){var f=c.rightPanel,i=a(b,f);if(i.size()==0){f=c.leftPanel;i=a(b,f)}var h=i.index(),g=i.siblings().size();if(i.size()==0||h==g){return}i.appendTo(a(".om-itemselector-items>dl",f));c._trigger("onSort",null,e.dataSource[i.attr("_index")],h,g)});a(".om-itemselector-tbar-moveUp",d).click(function(){var f=c.rightPanel,h=a(b,f);if(h.size()==0){f=c.leftPanel;h=a(b,f)}var g=h.index();if(h.size()==0||g==0){return}h.insertBefore(h.prev());c._trigger("onSort",null,e.dataSource[h.attr("_index")],g,g-1)});a(".om-itemselector-tbar-moveDown",d).click(function(){var f=c.rightPanel,h=a(b,f);if(h.size()==0){f=c.leftPanel;h=a(b,f)}var g=h.index();if(h.size()==0||g==h.siblings().size()){return}h.insertAfter(h.next());c._trigger("onSort",null,e.dataSource[h.attr("_index")],g,g+1)})}},_moveItemsToTarget:function(e,f){var d=f?this.leftPanel:this.rightPanel,i=a(".om-itemselector-items>dl>dt"+e,d);if(i.size()==0){return}var g=f?this.rightPanel:this.leftPanel,h=this.options,c=[];i.each(function(){c.push(h.dataSource[a(this).attr("_index")])});if(f){if(this._trigger("onBeforeItemSelect",null,c)===false){return}i.appendTo(a(".om-itemselector-items>dl",g));this._trigger("onItemSelect",null,c)}else{if(this._trigger("onBeforeItemDeselect",null,c)===false){return}i.appendTo(a(".om-itemselector-items>dl",g));this._trigger("onItemDeselect",null,c)}if(h.autoSort){var b=a(".om-itemselector-items>dl>dt",g).sort(function(k,j){return a(k).attr("_index")-a(j).attr("_index")});i.parent().append(b)}},value:function(c){if(arguments.length==0){var e=this.options,d=a(".om-itemselector-items>dl>dt",this.rightPanel),b=[];d.each(function(){b.push(e.dataSource[a(this).attr("_index")].value)});return b}else{if(a.isArray(c)){this.options.value=c;this._buildList()}}}})})(jQuery);