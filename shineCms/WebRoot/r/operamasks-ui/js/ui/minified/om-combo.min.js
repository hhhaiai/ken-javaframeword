(function(b){var a="_value";if(!Array.prototype.indexOf){Array.prototype.indexOf=function(e){var c=this.length;for(var d=0;d<c;d++){if(this[d]===e){return d}}return -1}}b.omWidget("om.omCombo",{options:{optionField:"text",valueField:"value",width:"auto",disabled:false,readOnly:false,editable:true,lazyLoad:false,listMaxHeight:300,listAutoWidth:false,autoFilter:true,filterStrategy:"first",filterDelay:500,multi:false,multiSeparator:","},_init:function(){var c=this.options,f=this.element,e=c.dataSource;if(!c.inputField){c.inputField=c.optionField}if(typeof c.value!=="undefined"){c.lazyLoad=false}if(c.width!="auto"){var d=f.parent().width(c.width);f.width(d.innerWidth()-f.next().outerWidth()-f.outerWidth()+f.width())}if(c.multi){c.editable=this.options.editable=false}this._refeshEmptyText(c.emptyText);c.disabled?f.attr("disabled",true):f.removeAttr("disabled");(c.readOnly||!c.editable)?f.attr("readonly","readOnly"):f.removeAttr("readonly");if(!c.lazyLoad){this._toggleLoading("add");if(e&&typeof e=="string"){this._ajaxLoad(e)}else{if(e&&typeof e=="object"){this._loadData(e);this._toggleLoading("remove")}else{this.dataHasLoaded=true;this._toggleLoading("remove")}}}else{this.dataHasLoaded=false}var g=c.disabled||c.readOnly;if(g){this.expandTrigger.addClass("om-state-disabled")}else{this._bindEvent()}},_create:function(){var d=this.element;d.attr("autocomplete","off");var c=b('<span class="om-combo om-widget om-state-default"></span>').insertAfter(d).wrapInner(d);this.expandTrigger=b('<span class="om-combo-trigger"></span>').appendTo(c);this.dropList=b(b('<div class="om-widget"><div class="om-widget-content om-droplist"></div></div>').css({position:"absolute",zIndex:2000}).appendTo(document.body).children()[0]).hide()},setData:function(e){var c=this;var d=c.element;c.options.value="";d.val("");c._toggleLoading("add");if(typeof e==="string"){c._ajaxLoad(e)}else{c._loadData(e);c._toggleLoading("remove")}},getData:function(){var c=this.options.dataSource;return(typeof c=="object")?c:null},value:function(c){if(typeof c==="undefined"){var d=b(this.element).attr(a);return d?d:""}else{this._setValue(c);return this}},disable:function(){var c=this.element;c.attr("disabled",true).unbind();this.options.disabled=true;this.expandTrigger.addClass("om-state-disabled").unbind()},enable:function(){var c=this.element;c.removeAttr("disabled").unbind();this.options.disabled=false;this.expandTrigger.removeClass("om-state-disabled").unbind();this._bindEvent()},destroy:function(){var c=this.element;b(document).unbind("mousedown.omCombo",this.globalEvent);c.parent().after(c).remove();this.dropList.parent().remove()},_bindEvent:function(){var e=this;var g=this.options;var d=this.element;var i=d.parent("span");var h=this.dropList;var j=this.expandTrigger;var c=g.emptyText;var f=false;i.mouseenter(function(){if(!g.disabled){i.addClass("om-state-hover")}}).mouseleave(function(){i.removeClass("om-state-hover")});d.focus(function(){if(f){return}f=true;b(".om-droplist").hide();i.addClass("om-state-focus");e._refeshEmptyText(c);if(!e.dataHasLoaded){if(!j.hasClass("om-loading")){e._toggleLoading("add");if(typeof(g.dataSource)=="object"){e._loadData(g.dataSource);e._toggleLoading("remove")}else{if(typeof(g.dataSource)=="string"){e._ajaxLoad(g.dataSource)}else{e.dataHasLoaded=true;e._toggleLoading("remove")}}}}if(!g.disabled&&!g.readOnly){e._showDropList()}}).blur(function(n){f=false;i.removeClass("om-state-focus");d.removeClass("om-combo-focus");if(!g.disabled&&!g.readOnly&&!g.multi){if(e.hasManualInput){e.hasManualInput=false;var o=d.val();if(o!==""){var p=b.data(d,"allInputText");var k=b.data(d,"allValues");var l=p.indexOf(o);if(l>-1){e._setValue(k[l])}else{var m=d.attr(a);l=k.indexOf(m);if(l>-1){d.val(p[l])}else{d.val("")}}}else{d.attr(a,"")}}e._refeshEmptyText(c)}}).keyup(function(m){var k=m.keyCode,l=b.om.keyCode;switch(k){case l.DOWN:e._selectNext();break;case l.UP:e._selectPrev();break;case l.ENTER:e._backfill(e.dropList.find(".om-state-hover"));break;case l.ESCAPE:h.hide();break;case l.TAB:break;default:e.hasManualInput=true;if(!g.disabled&&!g.readOnly&&g.editable&&g.autoFilter){if(window._omcomboFilterTimer){clearTimeout(window._omcomboFilterTimer)}window._omcomboFilterTimer=setTimeout(function(){if(b(document).attr("activeElement").id==d.attr("id")){h.show()}e._doFilter(d)},g.filterDelay)}}});i.mousedown(function(k){k.stopPropagation()});h.mousedown(function(k){k.stopPropagation()});j.click(function(){!j.hasClass("om-loading")&&d.focus()}).mousedown(function(){!j.hasClass("om-loading")&&i.addClass("om-state-active")}).mouseup(function(){!j.hasClass("om-loading")&&i.removeClass("om-state-active")});b(document).bind("mousedown.omCombo",this.globalEvent=function(){h.hide()})},_showDropList:function(){var o=this.element,j=this._getAllOptionsBeforeFiltered().removeClass("om-helper-hidden om-state-hover");if(j.size()<=0){return}var q=this.options,c=this.dropList.scrollTop(0).css("height","auto"),p,f=o.attr(a),l=c.find(".om-combo-list-row");l.removeClass("om-combo-selected");if(f!==undefined&&f!==""){var d=b.data(o,"allValues");if(q.multi){var k=f.split(q.multiSeparator);for(var e=0;e<k.length;e++){var g=d.indexOf(k[e]);if(g>-1){b(c.find(".om-combo-list-row").get(g)).addClass("om-combo-selected")}}valueItem=k[0]}else{var g=d?d.indexOf(f):-1;if(g>-1){p=b(c.find(".om-combo-list-row").get(g)).addClass("om-combo-selected")}}}var n=c.parent(),m=o.parent();if(!q.listAutoWidth){n.width(m.outerWidth())}else{if(b.browser.msie&&(b.browser.version=="7.0")&&!b.support.style){n.width(c.show().outerWidth())}else{n.width(c.outerWidth())}}if(q.listMaxHeight!="auto"&&c.show().height()>q.listMaxHeight){c.height(q.listMaxHeight).css("overflow-y","auto")}var h=m.offset();n.css({left:h.left,top:h.top+m.outerHeight()});c.show();if(p){c.scrollTop(b(p).offset().top-c.offset().top)}},_toggleLoading:function(c){if(!this.options.disabled){if(c=="add"){this.expandTrigger.removeClass("om-icon-carat-1-s").addClass("om-loading")}else{if(c=="remove"){this.expandTrigger.removeClass("om-loading").addClass("om-icon-carat-1-s")}}}},_ajaxLoad:function(e){var c=this;var d=this.options;b.ajax({url:e,method:"POST",dataType:"json",success:function(f,h){c.dataHasLoaded=true;var g=d.onSuccess;if(g&&c._trigger("onSuccess",null,f,h)===false){d.dataSource=f;return}c._loadData(f);c._toggleLoading("remove")},error:function(f,h,g){c.dataHasLoaded=true;if(d.onError){c._toggleLoading("remove");c._trigger("onError",null,f,h,g)}else{c._toggleLoading("remove");throw new Error('An error occurred while load records from URL "'+e+'",the error message is:'+g.message)}}})},_loadData:function(g){var n=this.options,j=this.element;n.dataSource=g;this.dataHasLoaded=true;var f=n.inputField;var h=[];if(typeof f==="string"){b(g).each(function(){h.push(this[f])})}else{b(g).each(function(o){h.push(f(this,o))})}b.data(j,"allInputText",h);var m=n.valueField;var d=[];if(typeof m==="string"){b(g).each(function(){d.push(this[m])})}else{b(g).each(function(o){d.push(m(this,o))})}b.data(j,"allValues",d);var c=this.dropList.empty();if(n.listProvider){var k=n.listProvider(c,g);if(k){k.each(function(){b(this).addClass("om-combo-list-row")})}}else{var i=n.optionField;var e="";var l=this;if(typeof i==="string"){b(g).each(function(o){e+=l._wrapText(this[n.optionField])})}else{b(g).each(function(o){e+=l._wrapText(n.optionField(this,o))})}if(e){b(e).appendTo(c);c.show().css("height","auto");if(n.listMaxHeight!="auto"&&c.height()>n.listMaxHeight){c.height(n.listMaxHeight).css("overflow-y","auto")}c.hide();if(j.parent().hasClass("om-state-hover")){l._showDropList()}}}if(n.value){this._setValue(n.value)}this._bindEventsToList()},_bindEventsToList:function(){var d=this._getAllOptionsBeforeFiltered();var c=this;d.hover(function(){d.removeClass("om-state-hover");b(this).addClass("om-state-hover")},function(){b(this).removeClass("om-state-hover")}).mousedown(function(){c._backfill(this)})},_wrapText:function(c){return'<div class="om-combo-list-row">'+c+"</div>"},_setValue:function(k){var j=this.element;var f=true;var c=j.attr(a);var m=this.options;if(k==c){f=false}var d=b.data(j,"allValues");var g=[],l=[];if(m.multi){l=k.split(m.multiSeparator)}else{l.push(k)}for(var e=0;e<l.length;e++){var h=d.indexOf(l[e]);if(h>-1){g.push(b.data(j,"allInputText")[h])}else{j.attr(a,"").val("");k=""}}j.attr(a,k);if(m.multi){j.val(g.join(this.options.multiSeparator))}else{j.val(g.join(""))}var m=this.options;m.value=k;if(m.onValueChange&&f){this._trigger("onValueChange",null,j,k,c)}this._refeshEmptyText(m.emptyText)},_findHighlightItem:function(){var c=this.dropList;var d=c.find(".om-state-hover");if(d.length>0){return d}var e=c.find(".om-combo-selected");return e.length>0?e[0]:e},_selectPrev:function(){var c=this._findHighlightItem();var e=this._getAllOptionsAfterFiltered();var g=e.index(c);var d=b(e[g]);if(g===0){g=e.length}else{if(g==-1){g=e.length}}var f=b(e[g-1]);this._highLisghtAndScrollTo(d,f)},_selectNext:function(){var e=this.dropList;if(e.css("display")=="none"){this._showDropList();return}var f=this._getAllOptionsAfterFiltered();var g=f.index(this._findHighlightItem());var d=b(f[g]);if(g==f.length-1){g=-1}var c=b(f[g+1]);this._highLisghtAndScrollTo(d,c)},_highLisghtAndScrollTo:function(d,e){var c=this.dropList;d.removeClass("om-state-hover");e.addClass("om-state-hover");if(e.position().top<=0){c.scrollTop(c.scrollTop()+e.position().top)}else{if(e.position().top+e.outerHeight()>c.height()){c.scrollTop(c.scrollTop()+e.position().top+e.outerHeight()-c.height())}}},_backfill:function(c){var k=this.element;var d=this.dropList;var l=this.options;var e=l.multi;if(e){b(c).toggleClass("om-combo-selected").removeClass("om-state-hover")}else{this._getAllOptionsBeforeFiltered().removeClass("om-combo-selected");b(c).addClass("om-combo-selected")}if(d.css("display")=="none"){return}var j=[];var h=d.find(".om-combo-selected");for(var g=0;g<h.length;g++){var f=b(h[g]).index();if(f>-1){j.push(b.data(k,"allValues")[f])}}this._setValue(j.join(e?l.multiSeparator:""));if(!e){d.hide()}},_getAllOptionsBeforeFiltered:function(){return this.dropList.find(".om-combo-list-row")},_getAllOptionsAfterFiltered:function(){var c=this.dropList;return c.find(".om-combo-list-row").not(c.find(".om-helper-hidden"))},_doFilter:function(){var i=this.element;var l=this.options;var e=l.dataSource;var d=l.filterStrategy;var j=i.val();var g=this._getAllOptionsBeforeFiltered();var h=b.data(i,"allInputText");var k=this;var f=false;b(e).each(function(m){if(k._filetrPass(d,j,e[m],h[m])){b(g.get(m)).removeClass("om-helper-hidden");f=true}else{b(g.get(m)).addClass("om-helper-hidden")}});var c=this.dropList.css("height","auto");if(l.listMaxHeight!="auto"&&c.height()>l.listMaxHeight){c.height(l.listMaxHeight).css("overflow-y","auto")}if(!f){c.hide()}},_filetrPass:function(e,g,c,f){if(g===""){return true}if(typeof e==="function"){return e(g,c)}else{if(e==="first"){return f.indexOf(g)===0}else{if(e==="anywhere"){return f.indexOf(g)>-1}else{if(e==="last"){var d=f.lastIndexOf(g);return d>-1&&d+g.length==f.length}else{return false}}}}},_refeshEmptyText:function(c){var d=this.element;if(!c){return}if(d.val()===""){d.val(c).addClass("om-empty-text")}else{if(d.val()===c){d.val("")}d.removeClass("om-empty-text")}}})})(jQuery);